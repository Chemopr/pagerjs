/*! pager.js - v0.3.0 - 2012-09-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
define(["jquery","underscore","knockout"],function(a,b,c){var d={},e={};e.value=c.utils.unwrapObservable,e.arrayValue=function(a){return b.map(a,function(a){return e.value(a)})};var f=function(a){var b,c={},d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))};while(b=e.exec(a))c[f(b[1])]=f(b[2]);return c},g=function(a){if(!a)return{name:null,params:{}};var b=a.split("?"),c=b[0],d=b[1],e={};return d&&(e=f(d)),{name:c,params:e}};return d.ChildManager=function(a,f){this.currentChildO=c.observable(null);var h=this;this.page=f,this.hideChild=function(){h.currentChild&&h.currentChild.getId()!=="start"&&(h.currentChild.hidePage(function(){}),h.currentChild=null,h.currentChildO(null))},this.showChild=function(c){var f=h.currentChild;h.currentChild=null;var i=!1,j=g(c[0]),k=j.name,l=null;b.each(a(),function(a){if(!i){var b=a.getId();if(b===k||(k===""||k==null)&&b==="start")i=!0,h.currentChild=a;b==="?"&&(l=a)}});var m=!1,n=h;while(!h.currentChild&&n.page.parentPage&&!n.page.getValue().modal){var o=n.page.parentPage.children;b.each(o(),function(a){if(!i){var b=a.getId(),c=a.getValue().modal;if(c){if(b===k||(k===""||k==null)&&b==="start")i=!0,h.currentChild=a,m=!0;b==="?"&&!l&&(l=a,m=!0)}}}),h.currentChild||(n=n.page.parentPage.childManager)}!h.currentChild&&l&&(h.currentChild=l,h.currentChild.currentId=k),h.currentChild&&(h.currentChildO(h.currentChild),m?h.currentChild.currentParentPage(h.page):h.currentChild.currentParentPage(null));var p=function(){d.navigationFailed&&d.navigationFailed(h.page,c),h.page.getValue().navigationFailed&&e.value(h.page.getValue().navigationFailed)(h.page,c)},q=function(){h.currentChild.showPage(c.slice(1),j,c[0])};f&&f===h.currentChild?q():f?f.hidePage(function(){h.currentChild?q():p()}):h.currentChild?q():p()}},d.start=function(){var b=function(){d.routeFromHashToPage(window.location.hash)};a(window).bind("hashchange",b),b()},d.extendWithPage=function(a){a.$__page__=new d.Page,d.childManager=new d.ChildManager(a.$__page__.children,a.$__page__),a.$__page__.childManager=d.childManager},d.navigationFailed=null,d.routeFromHashToPage=function(a){a[0]==="#"&&(a=a.slice(1));var b=decodeURIComponent(a).split("/");d.childManager.showChild(b)},d.Page=function(a,b,e,f,g){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=e,this.viewModel=f,this.bindingContext=g,this.children=c.observableArray([]),this.childManager=new d.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx,this.currentParentPage=c.observable(null),this.isVisible=c.observable(!1),this.originalRoute=c.observable(null)},d.Page.prototype.showPage=function(a,b,c){this.isVisible(!0),this.originalRoute(c),b&&b.params&&this.setParams(b.params),this.show(),this.childManager.showChild(a)},d.Page.prototype.setParams=function(d){var e=this.ctx,f=this.getValue().params||{};a.each(d,function(a,d){b.indexOf(f,a)!==-1&&(e[a]?e[a](d):e[a]=c.observable(d))})},d.Page.prototype.hidePage=function(a){this.isVisible(!1),this.hideElementWrapper(a),this.childManager.hideChild()},d.Page.prototype.init=function(){var b=this,d=this.getValue();return this.parentPage=this.getParentPage(),this.parentPage.children.push(this),this.hideElement(),d.source&&this.loadSource(d.source),this.ctx=null,d["with"]?this.ctx=e.value(d["with"]):d.withOnShow?this.ctx={}:this.ctx=this.viewModel,d.params&&a.each(d.params,function(a,d){b.ctx[d]||(b.ctx[d]=c.observable())}),this.childBindingContext=this.bindingContext.createChildContext(this.ctx),c.utils.extend(this.childBindingContext,{$page:this}),d.withOnShow||c.applyBindingsToDescendants(this.childBindingContext,this.element),{controlsDescendantBindings:!0}},d.Page.prototype.getValue=function(){return this.valueAccessor?e.value(this.valueAccessor()):{}},d.Page.prototype.getParentPage=function(){var a=this.bindingContext;while(a){if(a.$page)return a.$page;if(a.$data&&a.$data.$__page__)return a.$data.$__page__;a=a.$parentContext}return null},d.Page.prototype.getId=function(){return e.value(this.getValue().id)},d.Page.prototype.sourceUrl=function(a){var b=this;return this.getId()==="?"?c.computed(function(){return e.value(a).replace("{1}",b.currentId)}):c.computed(function(){return e.value(a)})},d.Page.prototype.loadSource=function(b){var f=this.getValue(),g=this,h=this.element,i=null,j=f.loader||d.loader;if(f.frame==="iframe"){var k=a("iframe",a(h));k.length===0&&(k=a("<iframe></iframe>"),a(h).append(k)),j&&(i=e.value(j)(g,k),i.load()),f.sourceLoaded&&k.one("load",function(){i&&i.unload(),f.sourceLoaded()}),c.applyBindingsToNode(k[0],{attr:{src:this.sourceUrl(b)}})}else j&&(i=e.value(j)(g,g.element),i.load()),c.computed(function(){if(typeof e.value(b)=="string"){var d=e.value(this.sourceUrl(b));a(h).load(d,function(){i&&i.unload(),c.applyBindingsToDescendants(g.childBindingContext,g.element),f.sourceLoaded&&f.sourceLoaded.apply(g,arguments)})}else e.value(b)(this,function(){f.sourceLoaded&&f.sourceLoaded()})},this)},d.Page.prototype.show=function(a){var d=this.element,e=this,f=this.getValue();this.showElementWrapper(a),this.getValue().title&&(window.document.title=this.getValue().title),f.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,f.withOnShow(b.bind(function(a){var b=this.bindingContext.createChildContext(a);e.ctx=a,c.utils.extend(b,{$page:this}),c.applyBindingsToDescendants(b,this.element)},this)))),f.sourceOnShow&&(!f.sourceCache||!d.__pagerLoaded__||typeof f.sourceCache=="number"&&d.__pagerLoaded__+f.sourceCache*1e3<Date.now())&&(d.__pagerLoaded__=Date.now(),this.loadSource(f.sourceOnShow))},d.Page.prototype.showElementWrapper=function(a){this.getValue().beforeShow&&this.getValue().beforeShow(this),this.showElement(a),this.getValue().afterShow&&this.getValue().afterShow(this)},d.Page.prototype.showElement=function(b){this.getValue().showElement?this.getValue().showElement(this,b):d.showElement?d.showElement(this,b):a(this.element).show(b)},d.Page.prototype.hideElementWrapper=function(a){this.getValue().beforeHide&&this.getValue().beforeHide(this),this.hideElement(a),this.getValue().afterHide&&this.getValue().afterHide(this)},d.Page.prototype.hideElement=function(b){this.getValue().hideElement?this.getValue().hideElement(this,b):d.hideElement?d.hideElement(this,b):(a(this.element).hide(),b&&b())},d.Page.prototype.getFullRoute=function(){return c.computed(function(){var a=null;return this.currentParentPage&&this.currentParentPage()?(a=this.currentParentPage().getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):this.parentPage?(a=this.parentPage.getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):[]},this)},c.bindingHandlers.page={init:function(a,b,c,e,f){var g=new d.Page(a,b,c,e,f);return g.init()},update:function(a,b,c,d,e){}},d.useHTML5history=!1,d.rootURI="/",c.bindingHandlers["page-href"]={init:function(b,f,g,h,i){var j=i.$page||i.$data.$page,k=j,l=c.computed(function(){var c=e.value(f()),d=0;while(c.substring(0,3)==="../")d++,c=c.slice(3);var g=k.getFullRoute()(),h=g.slice(0,g.length-d).join("/"),i=(h===""?"":h+"/")+c,j={href:"#"+i};return a(b).attr(j),i});d.useHTML5history&&window.history&&history.pushState&&a(b).click(function(a){a.preventDefault(),history.pushState(null,null,d.rootURI+l()),d.childManager.showChild(l().split("/"))})},update:function(){}},d.PageAccordionItem=function(a,b,c,e,f){d.Page.apply(this,arguments)},d.PageAccordionItem.prototype=new d.Page,d.PageAccordionItem.prototype.getAccordionBody=function(){return a(this.element).children()[1]},d.PageAccordionItem.prototype.hideElement=function(b){this.pageAccordionItemHidden?(a(this.getAccordionBody()).slideUp(),b&&b()):(this.pageAccordionItemHidden=!0,a(this.getAccordionBody()).hide())},d.PageAccordionItem.prototype.showElement=function(b){a(this.getAccordionBody()).slideDown(),b&&b()},c.bindingHandlers["page-accordion-item"]={init:function(a,b,c,e,f){var g=new d.PageAccordionItem(a,b,c,e,f);g.init()},update:function(){}},d});