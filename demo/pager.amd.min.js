/*! pager.js - v0.1.0 - 2012-08-14
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
define(["jquery","underscore","knockout"],function(a,b,c){var d={},e={};return e.value=c.utils.unwrapObservable,e.arrayValue=function(a){return b.map(a,function(a){return e.value(a)})},d.ChildManager=function(a,c){var d=null;this.showChild=function(){d&&(d.hide(),d=null);var f=!1,g=c()[0],h=null;b.each(a(),function(a){if(!f){var b=e.value(e.value(a.valueAccessor()).id);if(b===g||(g===""||g==null)&&b==="start")f=!0,d=a;b==="?"&&(h=a)}}),d||(d=h),d&&d.show()}},d.start=function(b){var c=function(){d.route(b.$page,window.location.hash)};a(window).bind("hashchange",c),c()},d.extendWithPage=function(a){a.$page=c.observable({children:c.observableArray([]),route:c.observableArray([]),parentRoute:c.observableArray([]),__id__:Math.random()}),d.childManager=new d.ChildManager(a.$page().children,a.$page().route)},d.route=function(a,b){b[0]==="#"&&(b=b.slice(1));var c=b.split("/");a().route(c),d.childManager.showChild()},d.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e},d.Page.prototype.init=function(){var a=this.getValue(),f=this.getPage(),g=c.observableArray([]),h=c.observableArray([]),i=this.element;f.children.push({valueAccessor:this.valueAccessor,element:i,page:f,show:b.bind(function(){this.show(),j.showChild()},this),hide:b.bind(function(){this.hideElement()},this)}),c.computed(function(){g(f.route().slice(1));var b=e.value(a).id;if(f.parentRoute){var c=f.parentRoute().slice(0);c.push(b),h(c)}else h([b])});var j=null,k={$page:c.observable({children:c.observableArray([]),parentRoute:h,route:g,__id__:Math.random()})};this.pagerValues=k,this.hideElement(),j=new d.ChildManager(k.$page().children,g),a.source&&this.loadSource(a.source);var l=null;return a["with"]?l=e.value(a["with"]):a.withOnShow?l={}:l=this.viewModel,this.childBindingContext=this.bindingContext.createChildContext(l),c.utils.extend(this.childBindingContext,k),c.applyBindingsToDescendants(this.childBindingContext,i),{controlsDescendantBindings:!0}},d.Page.prototype.getValue=function(){return e.value(this.valueAccessor())},d.Page.prototype.getPage=function(){return(this.bindingContext.$page||this.bindingContext.$data.$page)()},d.Page.prototype.sourceUrl=function(a){var b=this.getValue(),d=this.getPage();return e.value(b).id==="?"?c.computed(function(){return e.value(a).replace("{1}",d.route()[0])}):c.computed(function(){return e.value(a)})},d.Page.prototype.loadSource=function(b){var d=this.getValue(),f=this,g=this.element;if(d.frame==="iframe"){var h=a("iframe",a(g));h.length===0&&(h=a("<iframe></iframe>"),a(g).append(h)),d.sourceLoaded&&h.one("load",d.sourceLoaded),c.applyBindingsToNode(h[0],{attr:{src:this.sourceUrl(b)}})}else c.computed(function(){var h=e.value(this.sourceUrl(b));a(g).load(h,function(){c.applyBindingsToDescendants(f.childBindingContext,f.element),d.sourceLoaded&&d.sourceLoaded.apply(f,arguments)})},this)},d.Page.prototype.show=function(){var d=this.element,e=this.getValue(),f=a(d);this.isVisible()||(this.showElement(),e.withOnShow&&(this.withOnShowLoaded||(this.withOnShowLoaded=!0,e.withOnShow(b.bind(function(a){var b=this.bindingContext.createChildContext(a);c.utils.extend(b,this.pagerValues),c.applyBindingsToDescendants(b,this.element)},this)))),e.sourceOnShow&&(!e.sourceCache||!d.__pagerLoaded__||typeof e.sourceCache=="number"&&d.__pagerLoaded__+e.sourceCache*1e3<Date.now())&&(d.__pagerLoaded__=Date.now(),this.loadSource(e.sourceOnShow)))},d.Page.prototype.showElement=function(){a(this.element).show()},d.Page.prototype.hideElement=function(){a(this.element).hide()},d.Page.prototype.isVisible=function(){return a(this.element).is(":visible")},c.bindingHandlers.page={init:function(a,b,c,e,f){var g=new d.Page(a,b,c,e,f);return g.init()},update:function(a,b,c,d,e){}},c.bindingHandlers["page-href"]={init:function(b,d,f,g,h){var i=h.$page||h.$data.$page,j=i();c.computed(function(){var f=c.utils.unwrapObservable(d()),g=0;while(f.substring(0,3)==="../")g++,f=f.slice(3);var h=e.arrayValue(j.parentRoute().slice(0,j.parentRoute().length-g)).join("/");a(b).attr({href:"#"+(h===""?"":h+"/")+f})})},update:function(){}},d.PageAccordionItem=function(a,b,c,e,f){d.Page.apply(this,arguments)},d.PageAccordionItem.prototype=new d.Page,d.PageAccordionItem.prototype.getAccordionBody=function(){return a(this.element).children()[1]},d.PageAccordionItem.prototype.hideElement=function(){this.pageAccordionItemHidden?a(this.getAccordionBody()).slideUp():(this.pageAccordionItemHidden=!0,a(this.getAccordionBody()).hide())},d.PageAccordionItem.prototype.showElement=function(){a(this.getAccordionBody()).slideDown()},d.PageAccordionItem.prototype.isVisible=function(){return a(this.getAccordionBody()).is(":visible")},c.bindingHandlers["page-accordion-item"]={init:function(a,b,c,e,f){var g=new d.PageAccordionItem(a,b,c,e,f);g.init()},update:function(){}},d});